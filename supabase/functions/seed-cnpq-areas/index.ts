import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

interface CnpqEntry {
  code: string;
  name: string;
  level: number;
  parent_code: string | null;
  full_path: string;
}

// Official CNPq Knowledge Areas Table
const GRANDE_AREAS: Record<string, string> = {
  "10000003": "Ciências Exatas e da Terra",
  "20000006": "Ciências Biológicas",
  "30000009": "Engenharias",
  "40000001": "Ciências da Saúde",
  "50000005": "Ciências Agrárias",
  "60000008": "Ciências Sociais Aplicadas",
  "70000000": "Ciências Humanas",
  "80000002": "Linguística, Letras e Artes",
  "90000005": "Multidisciplinar",
};

// All areas organized as [code, name, parentCode]
const RAW_DATA: [string, string, string | null][] = [
  // === GRANDE ÁREAS ===
  ["10000003", "Ciências Exatas e da Terra", null],
  ["20000006", "Ciências Biológicas", null],
  ["30000009", "Engenharias", null],
  ["40000001", "Ciências da Saúde", null],
  ["50000005", "Ciências Agrárias", null],
  ["60000008", "Ciências Sociais Aplicadas", null],
  ["70000000", "Ciências Humanas", null],
  ["80000002", "Linguística, Letras e Artes", null],
  ["90000005", "Multidisciplinar", null],

  // === 1. CIÊNCIAS EXATAS E DA TERRA ===
  // Matemática
  ["10100008", "Matemática", "10000003"],
  ["10101004", "Álgebra", "10100008"],
  ["10101012", "Conjuntos", "10101004"],
  ["10101020", "Lógica Matemática", "10101004"],
  ["10101039", "Teoria dos Números", "10101004"],
  ["10101047", "Grupos e Álgebra Linear", "10101004"],
  ["10101055", "Álgebra Comutativa", "10101004"],
  ["10101063", "Álgebra Não-Comutativa", "10101004"],
  ["10102000", "Análise", "10100008"],
  ["10102019", "Análise Complexa", "10102000"],
  ["10102027", "Análise Funcional", "10102000"],
  ["10102035", "Análise Funcional Não-Linear", "10102000"],
  ["10102043", "Equações Diferenciais Ordinárias", "10102000"],
  ["10102051", "Equações Diferenciais Parciais", "10102000"],
  ["10102060", "Equações Diferenciais Funcionais", "10102000"],
  ["10103007", "Geometria e Topologia", "10100008"],
  ["10103015", "Geometria Diferencial", "10103007"],
  ["10103023", "Geometria Algébrica", "10103007"],
  ["10103031", "Topologia Algébrica", "10103007"],
  ["10103040", "Topologia das Variedades", "10103007"],
  ["10103058", "Sistemas Dinâmicos", "10103007"],
  ["10103066", "Teoria das Singularidades e Teoria das Catástrofes", "10103007"],
  ["10104003", "Matemática Aplicada", "10100008"],
  ["10104011", "Física Matemática", "10104003"],
  ["10104020", "Análise Numérica", "10104003"],
  ["10104038", "Matemática Discreta e Combinatória", "10104003"],
  ["10104046", "Otimização", "10104003"],

  // Probabilidade e Estatística
  ["10200002", "Probabilidade e Estatística", "10000003"],
  ["10201009", "Probabilidade", "10200002"],
  ["10201017", "Teoria Geral e Fundamentos da Probabilidade", "10201009"],
  ["10201025", "Teoria Geral e Processos Estocásticos", "10201009"],
  ["10201033", "Teoremas de Limite", "10201009"],
  ["10201041", "Processos Markovianos", "10201009"],
  ["10201050", "Análise Estocástica", "10201009"],
  ["10201068", "Processos Estocásticos Especiais", "10201009"],
  ["10202005", "Estatística", "10200002"],
  ["10202013", "Fundamentos da Estatística", "10202005"],
  ["10202021", "Inferência Paramétrica", "10202005"],
  ["10202030", "Inferência Não-Paramétrica", "10202005"],
  ["10202048", "Inferência em Processos Estocásticos", "10202005"],
  ["10202056", "Análise Multivariada", "10202005"],
  ["10202064", "Regressão e Correlação", "10202005"],
  ["10202072", "Planejamento de Experimentos", "10202005"],
  ["10202080", "Análise de Dados", "10202005"],
  ["10203001", "Probabilidade e Estatística Aplicadas", "10200002"],

  // Ciência da Computação
  ["10300007", "Ciência da Computação", "10000003"],
  ["10301003", "Teoria da Computação", "10300007"],
  ["10301011", "Computabilidade e Modelos de Computação", "10301003"],
  ["10301020", "Linguagens Formais e Autômatos", "10301003"],
  ["10301038", "Análise de Algoritmos e Complexidade de Computação", "10301003"],
  ["10301046", "Lógicas e Semântica de Programas", "10301003"],
  ["10302000", "Matemática da Computação", "10300007"],
  ["10302018", "Matemática Simbólica", "10302000"],
  ["10302026", "Modelos Analíticos e de Simulação", "10302000"],
  ["10303006", "Metodologia e Técnicas da Computação", "10300007"],
  ["10303014", "Linguagens de Programação", "10303006"],
  ["10303022", "Engenharia de Software", "10303006"],
  ["10303030", "Banco de Dados", "10303006"],
  ["10303049", "Sistemas de Informação", "10303006"],
  ["10303057", "Processamento Gráfico (Graphics)", "10303006"],
  ["10304002", "Sistemas de Computação", "10300007"],
  ["10304010", "Hardware", "10304002"],
  ["10304029", "Arquitetura de Sistemas de Computação", "10304002"],
  ["10304037", "Software Básico", "10304002"],
  ["10304045", "Teleinformática", "10304002"],

  // Astronomia
  ["10400001", "Astronomia", "10000003"],
  ["10401008", "Astronomia de Posição e Mecânica Celeste", "10400001"],
  ["10401016", "Astronomia Fundamental", "10401008"],
  ["10401024", "Astronomia Dinâmica", "10401008"],
  ["10402004", "Astrofísica Estelar", "10400001"],
  ["10403000", "Astrofísica do Meio Interestelar", "10400001"],
  ["10403019", "Meio Interestelar", "10403000"],
  ["10403027", "Nebulosa", "10403000"],
  ["10404007", "Astrofísica Extragalactica", "10400001"],
  ["10404015", "Galáxias", "10404007"],
  ["10404023", "Aglomerados de Galáxias", "10404007"],
  ["10404031", "Quasares", "10404007"],
  ["10404040", "Cosmologia", "10404007"],
  ["10405003", "Astrofísica do Sistema Solar", "10400001"],
  ["10405011", "Física Solar", "10405003"],
  ["10405020", "Movimento da Terra", "10405003"],
  ["10405038", "Sistema Planetário", "10405003"],
  ["10406000", "Instrumentação Astronômica", "10400001"],
  ["10406018", "Astronomia Ótica", "10406000"],
  ["10406026", "Radioastronomia", "10406000"],
  ["10406034", "Astronomia Espacial", "10406000"],
  ["10406042", "Processamento de Dados Astronômicos", "10406000"],

  // Física
  ["10500006", "Física", "10000003"],
  ["10501002", "Física Geral", "10500006"],
  ["10501010", "Métodos Matemáticos da Física", "10501002"],
  ["10501029", "Física Clássica e Física Quântica; Mecânica e Campos", "10501002"],
  ["10501037", "Relatividade e Gravitação", "10501002"],
  ["10501045", "Física Estatística e Termodinâmica", "10501002"],
  ["10501053", "Metrologia, Técnicas Gerais de Laboratório", "10501002"],
  ["10501061", "Instrumentação Específica de Uso Geral em Física", "10501002"],
  ["10502009", "Áreas Clássicas de Fenomenologia e suas Aplicações", "10500006"],
  ["10502017", "Eletricidade e Magnetismo", "10502009"],
  ["10502025", "Ótica", "10502009"],
  ["10502033", "Acústica", "10502009"],
  ["10502041", "Transferência de Calor", "10502009"],
  ["10502050", "Mecânica, Elasticidade e Reologia", "10502009"],
  ["10502068", "Dinâmica dos Fluídos", "10502009"],
  ["10503005", "Física das Partículas Elementares e Campos", "10500006"],
  ["10504001", "Física Nuclear", "10500006"],
  ["10505008", "Física Atômica e Molecular", "10500006"],
  ["10506004", "Física dos Fluídos, Física de Plasmas e Descargas Elétricas", "10500006"],
  ["10507000", "Física da Matéria Condensada", "10500006"],

  // Química
  ["10600000", "Química", "10000003"],
  ["10601007", "Química Orgânica", "10600000"],
  ["10601015", "Estrutura, Conformação e Estereoquímica", "10601007"],
  ["10601023", "Síntese Orgânica", "10601007"],
  ["10601031", "Físico-Química Orgânica", "10601007"],
  ["10601040", "Fotoquímica Orgânica", "10601007"],
  ["10601058", "Química dos Produtos Naturais", "10601007"],
  ["10601066", "Evolução, Sistemática e Ecologia Química", "10601007"],
  ["10601074", "Polímeros e Colóides", "10601007"],
  ["10602003", "Química Inorgânica", "10600000"],
  ["10603000", "Físico-Química", "10600000"],
  ["10604006", "Química Analítica", "10600000"],

  // Geociências
  ["10700005", "Geociências", "10000003"],
  ["10701001", "Geologia", "10700005"],
  ["10702008", "Geofísica", "10700005"],
  ["10703004", "Meteorologia", "10700005"],
  ["10704000", "Geodésia", "10700005"],
  ["10705007", "Geografia Física", "10700005"],

  // Oceanografia
  ["10800000", "Oceanografia", "10000003"],
  ["10801006", "Oceanografia Biológica", "10800000"],
  ["10802002", "Oceanografia Física", "10800000"],
  ["10803009", "Oceanografia Química", "10800000"],
  ["10804005", "Oceanografia Geológica", "10800000"],

  // === 2. CIÊNCIAS BIOLÓGICAS ===
  ["20100000", "Biologia Geral", "20000006"],
  ["20200005", "Genética", "20000006"],
  ["20201001", "Genética Quantitativa", "20200005"],
  ["20202008", "Genética Molecular e de Microorganismos", "20200005"],
  ["20203004", "Genética Vegetal", "20200005"],
  ["20204000", "Genética Animal", "20200005"],
  ["20205007", "Genética Humana e Médica", "20200005"],
  ["20206003", "Mutagênese", "20200005"],
  ["20300000", "Botânica", "20000006"],
  ["20301006", "Paleobotânica", "20300000"],
  ["20302002", "Morfologia Vegetal", "20300000"],
  ["20303009", "Fisiologia Vegetal", "20300000"],
  ["20304005", "Taxonomia Vegetal", "20300000"],
  ["20305001", "Fitogeografia", "20300000"],
  ["20306008", "Botânica Aplicada", "20300000"],
  ["20400004", "Zoologia", "20000006"],
  ["20401000", "Paleozoologia", "20400004"],
  ["20402007", "Morfologia dos Grupos Recentes", "20400004"],
  ["20403003", "Fisiologia dos Grupos Recentes", "20400004"],
  ["20404000", "Comportamento Animal", "20400004"],
  ["20405006", "Taxonomia dos Grupos Recentes", "20400004"],
  ["20406002", "Zoologia Aplicada", "20400004"],
  ["20500009", "Ecologia", "20000006"],
  ["20501005", "Ecologia Teórica", "20500009"],
  ["20502001", "Ecologia de Ecossistemas", "20500009"],
  ["20503008", "Ecologia Aplicada", "20500009"],
  ["20600003", "Morfologia", "20000006"],
  ["20601000", "Citologia e Biologia Celular", "20600003"],
  ["20602006", "Embriologia", "20600003"],
  ["20603002", "Histologia", "20600003"],
  ["20604009", "Anatomia", "20600003"],
  ["20700008", "Fisiologia", "20000006"],
  ["20701004", "Fisiologia Geral", "20700008"],
  ["20702000", "Fisiologia de Órgãos e Sistemas", "20700008"],
  ["20703007", "Fisiologia do Esforço", "20700008"],
  ["20704003", "Fisiologia Comparada", "20700008"],
  ["20800002", "Bioquímica", "20000006"],
  ["20801009", "Química de Macromoléculas", "20800002"],
  ["20802005", "Bioquímica dos Microorganismos", "20800002"],
  ["20803001", "Metabolismo e Bioenergética", "20800002"],
  ["20804008", "Biologia Molecular", "20800002"],
  ["20805004", "Enzimologia", "20800002"],
  ["20900007", "Biofísica", "20000006"],
  ["20901003", "Biofísica Molecular", "20900007"],
  ["20902000", "Biofísica Celular", "20900007"],
  ["20903006", "Biofísica de Processos e Sistemas", "20900007"],
  ["20904002", "Radiologia e Fotobiologia", "20900007"],
  ["21000000", "Farmacologia", "20000006"],
  ["21001006", "Farmacologia Geral", "21000000"],
  ["21002002", "Farmacologia Autonômica", "21000000"],
  ["21003009", "Neuropsicofarmacologia", "21000000"],
  ["21004005", "Farmacologia Cardiorenal", "21000000"],
  ["21005001", "Farmacologia Bioquímica e Molecular", "21000000"],
  ["21006008", "Etnofarmacologia", "21000000"],
  ["21007004", "Toxicologia", "21000000"],
  ["21008000", "Farmacologia Clínica", "21000000"],
  ["21100004", "Imunologia", "20000006"],
  ["21101000", "Imunoquímica", "21100004"],
  ["21102007", "Imunologia Celular", "21100004"],
  ["21103003", "Imunogenética", "21100004"],
  ["21104000", "Imunologia Aplicada", "21100004"],
  ["21200009", "Microbiologia", "20000006"],
  ["21201005", "Biologia e Fisiologia dos Microorganismos", "21200009"],
  ["21202001", "Microbiologia Aplicada", "21200009"],
  ["21300003", "Parasitologia", "20000006"],
  ["21301000", "Protozoologia de Parasitos", "21300003"],
  ["21302006", "Helmintologia de Parasitos", "21300003"],
  ["21303002", "Entomologia e Malacologia de Parasitos e Vetores", "21300003"],
  ["21400008", "Biotecnologia", "20000006"],
  ["21401004", "Biotecnologia em Saúde Humana e Animal", "21400008"],
  ["21402000", "Biotecnologia Industrial", "21400008"],
  ["21403007", "Biotecnologia Vegetal", "21400008"],
  ["21404003", "Biotecnologia Ambiental e Recursos Naturais", "21400008"],

  // === 3. ENGENHARIAS ===
  ["30100003", "Engenharia Civil", "30000009"],
  ["30101000", "Construção Civil", "30100003"],
  ["30102006", "Estruturas", "30100003"],
  ["30103002", "Geotécnica", "30100003"],
  ["30104009", "Engenharia Hidráulica", "30100003"],
  ["30105005", "Infra-Estrutura de Transportes", "30100003"],
  ["30200008", "Engenharia de Minas", "30000009"],
  ["30201004", "Pesquisa Mineral", "30200008"],
  ["30202000", "Lavra", "30200008"],
  ["30203007", "Tratamento de Minérios", "30200008"],
  ["30300002", "Engenharia de Materiais e Metalúrgica", "30000009"],
  ["30301009", "Instalações e Equipamentos Metalúrgicos", "30300002"],
  ["30302005", "Metalurgia Extrativa", "30300002"],
  ["30303001", "Metalurgia de Transformação", "30300002"],
  ["30304008", "Metalurgia Física", "30300002"],
  ["30305004", "Materiais Não-Metálicos", "30300002"],
  ["30400007", "Engenharia Elétrica", "30000009"],
  ["30401003", "Materiais Elétricos", "30400007"],
  ["30402000", "Medidas Elétricas, Magnéticas e Eletrônicas", "30400007"],
  ["30403006", "Circuitos Elétricos, Magnéticos e Eletrônicos", "30400007"],
  ["30404002", "Sistemas Elétricos de Potência", "30400007"],
  ["30405009", "Eletrônica Industrial, Sistemas e Controles Eletrônicos", "30400007"],
  ["30406005", "Telecomunicações", "30400007"],
  ["30500001", "Engenharia Mecânica", "30000009"],
  ["30501008", "Fenômenos de Transporte", "30500001"],
  ["30502004", "Engenharia Térmica", "30500001"],
  ["30503000", "Mecânica dos Sólidos", "30500001"],
  ["30504007", "Projetos de Máquinas", "30500001"],
  ["30505003", "Processos de Fabricação", "30500001"],
  ["30600006", "Engenharia Química", "30000009"],
  ["30700000", "Engenharia Sanitária", "30000009"],
  ["30701007", "Recursos Hídricos", "30700000"],
  ["30702003", "Tratamento de Águas de Abastecimento e Residuárias", "30700000"],
  ["30703000", "Saneamento Básico", "30700000"],
  ["30704006", "Saneamento Ambiental", "30700000"],
  ["30800005", "Engenharia de Produção", "30000009"],
  ["30801001", "Gerência de Produção", "30800005"],
  ["30802008", "Pesquisa Operacional", "30800005"],
  ["30803004", "Engenharia do Produto", "30800005"],
  ["30804000", "Engenharia Econômica", "30800005"],
  ["30900000", "Engenharia Nuclear", "30000009"],
  ["31000002", "Engenharia de Transportes", "30000009"],
  ["31001009", "Planejamento de Transportes", "31000002"],
  ["31002005", "Veículos e Equipamentos de Controle", "31000002"],
  ["31003001", "Operações de Transportes", "31000002"],
  ["31100007", "Engenharia Naval e Oceânica", "30000009"],
  ["31200001", "Engenharia Aeroespacial", "30000009"],
  ["31300006", "Engenharia Biomédica", "30000009"],
  ["31301002", "Bioengenharia", "31300006"],
  ["31302009", "Engenharia Médica", "31300006"],
  ["31400000", "Engenharia de Energia", "30000009"],
  ["31401007", "Planejamento Energético", "31400000"],
  ["31402003", "Fontes Renováveis de Energia", "31400000"],

  // === 4. CIÊNCIAS DA SAÚDE ===
  ["40100006", "Medicina", "40000001"],
  ["40101002", "Clínica Médica", "40100006"],
  ["40102009", "Cirurgia", "40100006"],
  ["40103005", "Saúde Materno-Infantil", "40100006"],
  ["40104001", "Psiquiatria", "40100006"],
  ["40105008", "Anatomia Patológica e Patologia Clínica", "40100006"],
  ["40106004", "Radiologia Médica", "40100006"],
  ["40107000", "Medicina Legal e Deontologia", "40100006"],
  ["40200000", "Odontologia", "40000001"],
  ["40201007", "Clínica Odontológica", "40200000"],
  ["40202003", "Cirurgia Buco-Maxilo-Facial", "40200000"],
  ["40203000", "Ortodontia", "40200000"],
  ["40204006", "Endodontia", "40200000"],
  ["40205002", "Periodontia", "40200000"],
  ["40206009", "Radiologia Odontológica", "40200000"],
  ["40207005", "Odontologia Social e Preventiva", "40200000"],
  ["40208001", "Materiais Odontológicos", "40200000"],
  ["40300005", "Farmácia", "40000001"],
  ["40301001", "Farmacotecnia", "40300005"],
  ["40302008", "Farmacognosia", "40300005"],
  ["40303004", "Análise Toxicológica", "40300005"],
  ["40304000", "Análise e Controle de Medicamentos", "40300005"],
  ["40305007", "Bromatologia", "40300005"],
  ["40400000", "Enfermagem", "40000001"],
  ["40401006", "Enfermagem Médico-Cirúrgica", "40400000"],
  ["40402002", "Enfermagem Obstétrica", "40400000"],
  ["40403009", "Enfermagem Pediátrica", "40400000"],
  ["40404005", "Enfermagem Psiquiátrica", "40400000"],
  ["40405001", "Enfermagem de Doenças Contagiosas", "40400000"],
  ["40406008", "Enfermagem de Saúde Pública", "40400000"],
  ["40500004", "Nutrição", "40000001"],
  ["40501000", "Bioquímica da Nutrição", "40500004"],
  ["40502007", "Dietética", "40500004"],
  ["40503003", "Análise Nutricional de Populações", "40500004"],
  ["40504000", "Desnutrição e Desenvolvimento Fisiológico", "40500004"],
  ["40600009", "Saúde Coletiva", "40000001"],
  ["40601005", "Epidemiologia", "40600009"],
  ["40602001", "Saúde Pública", "40600009"],
  ["40603008", "Medicina Preventiva", "40600009"],
  ["40700003", "Fonoaudiologia", "40000001"],
  ["40800008", "Fisioterapia e Terapia Ocupacional", "40000001"],
  ["40900002", "Educação Física", "40000001"],

  // === 5. CIÊNCIAS AGRÁRIAS ===
  ["50100000", "Agronomia", "50000005"],
  ["50101006", "Ciência do Solo", "50100000"],
  ["50102002", "Fitossanidade", "50100000"],
  ["50103009", "Fitotecnia", "50100000"],
  ["50104005", "Floricultura, Parques e Jardins", "50100000"],
  ["50105001", "Agrometeorologia", "50100000"],
  ["50106008", "Extensão Rural", "50100000"],
  ["50200004", "Recursos Florestais e Engenharia Florestal", "50000005"],
  ["50201000", "Silvicultura", "50200004"],
  ["50202007", "Manejo Florestal", "50200004"],
  ["50203003", "Técnicas e Operações Florestais", "50200004"],
  ["50204000", "Tecnologia e Utilização de Produtos Florestais", "50200004"],
  ["50205006", "Conservação da Natureza", "50200004"],
  ["50206002", "Energia de Biomassa Florestal", "50200004"],
  ["50300009", "Engenharia Agrícola", "50000005"],
  ["50301005", "Máquinas e Implementos Agrícolas", "50300009"],
  ["50302001", "Engenharia de Água e Solo", "50300009"],
  ["50303008", "Engenharia de Processamento de Produtos Agrícolas", "50300009"],
  ["50304004", "Construções Rurais e Ambiência", "50300009"],
  ["50305000", "Energização Rural", "50300009"],
  ["50400003", "Zootecnia", "50000005"],
  ["50401000", "Ecologia dos Animais Domésticos e Etologia", "50400003"],
  ["50402006", "Genética e Melhoramento dos Animais Domésticos", "50400003"],
  ["50403002", "Nutrição e Alimentação Animal", "50400003"],
  ["50404009", "Produção Animal", "50400003"],
  ["50500008", "Medicina Veterinária", "50000005"],
  ["50501004", "Clínica e Cirurgia Animal", "50500008"],
  ["50502000", "Medicina Veterinária Preventiva", "50500008"],
  ["50503007", "Patologia Animal", "50500008"],
  ["50504003", "Reprodução Animal", "50500008"],
  ["50505000", "Inspeção de Produtos de Origem Animal", "50500008"],
  ["50600002", "Recursos Pesqueiros e Engenharia de Pesca", "50000005"],
  ["50601009", "Recursos Pesqueiros Marinhos", "50600002"],
  ["50602005", "Recursos Pesqueiros de Águas Interiores", "50600002"],
  ["50603001", "Aquicultura", "50600002"],
  ["50604008", "Engenharia de Pesca", "50600002"],
  ["50700007", "Ciência e Tecnologia de Alimentos", "50000005"],
  ["50701003", "Ciência de Alimentos", "50700007"],
  ["50702000", "Tecnologia de Alimentos", "50700007"],
  ["50703006", "Engenharia de Alimentos", "50700007"],

  // === 6. CIÊNCIAS SOCIAIS APLICADAS ===
  ["60100002", "Direito", "60000008"],
  ["60101009", "Teoria do Direito", "60100002"],
  ["60102004", "Direito Público", "60100002"],
  ["60103000", "Direito Privado", "60100002"],
  ["60104007", "Direitos Especiais", "60100002"],
  ["60200006", "Administração", "60000008"],
  ["60201002", "Administração de Empresas", "60200006"],
  ["60202009", "Administração Pública", "60200006"],
  ["60203005", "Administração de Setores Específicos", "60200006"],
  ["60204001", "Ciências Contábeis", "60200006"],
  ["60300000", "Economia", "60000008"],
  ["60301007", "Teoria Econômica", "60300000"],
  ["60302003", "Métodos Quantitativos em Economia", "60300000"],
  ["60303000", "Economia Monetária e Fiscal", "60300000"],
  ["60304006", "Crescimento, Flutuações e Planejamento Econômico", "60300000"],
  ["60305002", "Economia Internacional", "60300000"],
  ["60306009", "Economia dos Recursos Humanos", "60300000"],
  ["60307005", "Economia Industrial", "60300000"],
  ["60308001", "Economia do Bem-Estar Social", "60300000"],
  ["60309008", "Economia Regional e Urbana", "60300000"],
  ["60310006", "Economias Agrária e dos Recursos Naturais", "60300000"],
  ["60400005", "Arquitetura e Urbanismo", "60000008"],
  ["60401001", "Fundamentos de Arquitetura e Urbanismo", "60400005"],
  ["60402008", "Projeto de Arquitetura e Urbanismo", "60400005"],
  ["60403004", "Tecnologia de Arquitetura e Urbanismo", "60400005"],
  ["60404000", "Paisagismo", "60400005"],
  ["60500000", "Planejamento Urbano e Regional", "60000008"],
  ["60501006", "Fundamentos do Planejamento Urbano e Regional", "60500000"],
  ["60502002", "Métodos e Técnicas do Planejamento Urbano e Regional", "60500000"],
  ["60503009", "Serviços Urbanos e Regionais", "60500000"],
  ["60600004", "Demografia", "60000008"],
  ["60601000", "Distribuição Espacial", "60600004"],
  ["60602007", "Tendência Populacional", "60600004"],
  ["60603003", "Componentes da Dinâmica Demográfica", "60600004"],
  ["60604000", "Nupcialidade e Família", "60600004"],
  ["60605006", "Demografia Histórica", "60600004"],
  ["60606002", "Política Pública e População", "60600004"],
  ["60607009", "Fontes de Dados Demográficos", "60600004"],
  ["60700009", "Ciência da Informação", "60000008"],
  ["60701005", "Teoria da Informação", "60700009"],
  ["60702001", "Biblioteconomia", "60700009"],
  ["60703008", "Arquivologia", "60700009"],
  ["60800003", "Museologia", "60000008"],
  ["60900008", "Comunicação", "60000008"],
  ["60901004", "Teoria da Comunicação", "60900008"],
  ["60902000", "Jornalismo e Editoração", "60900008"],
  ["60903007", "Rádio e Televisão", "60900008"],
  ["60904003", "Relações Públicas e Propaganda", "60900008"],
  ["60905000", "Comunicação Visual e Cinema", "60900008"],
  ["61000000", "Serviço Social", "60000008"],
  ["61001007", "Fundamentos do Serviço Social", "61000000"],
  ["61002003", "Serviço Social Aplicado", "61000000"],
  ["61100005", "Economia Doméstica", "60000008"],
  ["61200000", "Desenho Industrial", "60000008"],
  ["61201006", "Programação Visual", "61200000"],
  ["61202002", "Desenho de Produto", "61200000"],
  ["61300004", "Turismo", "60000008"],

  // === 7. CIÊNCIAS HUMANAS ===
  ["70100004", "Filosofia", "70000000"],
  ["70101000", "História da Filosofia", "70100004"],
  ["70102007", "Metafísica", "70100004"],
  ["70103003", "Lógica", "70100004"],
  ["70104000", "Ética", "70100004"],
  ["70105006", "Epistemologia", "70100004"],
  ["70106002", "Filosofia Brasileira", "70100004"],
  ["70107009", "Estética e Filosofia da Arte", "70100004"],
  ["70200009", "Sociologia", "70000000"],
  ["70201005", "Fundamentos da Sociologia", "70200009"],
  ["70202001", "Sociologia do Conhecimento", "70200009"],
  ["70203008", "Sociologia do Desenvolvimento", "70200009"],
  ["70204004", "Sociologia Urbana", "70200009"],
  ["70205000", "Sociologia Rural", "70200009"],
  ["70206007", "Sociologia da Saúde", "70200009"],
  ["70207003", "Outras Sociologias Específicas", "70200009"],
  ["70300003", "Antropologia", "70000000"],
  ["70301000", "Teoria Antropológica", "70300003"],
  ["70302006", "Etnologia Indígena", "70300003"],
  ["70303002", "Antropologia Urbana", "70300003"],
  ["70304009", "Antropologia Rural", "70300003"],
  ["70305005", "Antropologia das Populações Afro-Brasileiras", "70300003"],
  ["70400008", "Arqueologia", "70000000"],
  ["70401004", "Teoria e Método em Arqueologia", "70400008"],
  ["70402000", "Arqueologia Pré-Histórica", "70400008"],
  ["70403007", "Arqueologia Histórica", "70400008"],
  ["70500002", "História", "70000000"],
  ["70501009", "Teoria e Filosofia da História", "70500002"],
  ["70502005", "História Antiga e Medieval", "70500002"],
  ["70503001", "História Moderna e Contemporânea", "70500002"],
  ["70504008", "História da América", "70500002"],
  ["70505004", "História do Brasil", "70500002"],
  ["70506000", "História das Ciências", "70500002"],
  ["70600007", "Geografia", "70000000"],
  ["70601003", "Geografia Humana", "70600007"],
  ["70602000", "Geografia Regional", "70600007"],
  ["70700001", "Psicologia", "70000000"],
  ["70701008", "Fundamentos e Medidas da Psicologia", "70700001"],
  ["70702004", "Psicologia Experimental", "70700001"],
  ["70703000", "Psicologia Fisiológica", "70700001"],
  ["70704007", "Psicologia Comparativa", "70700001"],
  ["70705003", "Psicologia Social", "70700001"],
  ["70706000", "Psicologia Cognitiva", "70700001"],
  ["70707006", "Psicologia do Desenvolvimento Humano", "70700001"],
  ["70708002", "Psicologia do Ensino e da Aprendizagem", "70700001"],
  ["70709009", "Psicologia do Trabalho e Organizacional", "70700001"],
  ["70710007", "Tratamento e Prevenção Psicológica", "70700001"],
  ["70800006", "Educação", "70000000"],
  ["70801002", "Fundamentos da Educação", "70800006"],
  ["70802009", "Administração Educacional", "70800006"],
  ["70803005", "Política, Planejamento e Avaliação Educacional", "70800006"],
  ["70804001", "Ensino-Aprendizagem", "70800006"],
  ["70805008", "Currículo", "70800006"],
  ["70806004", "Orientação e Aconselhamento", "70800006"],
  ["70807000", "Tópicos Específicos de Educação", "70800006"],
  ["70808007", "Educação e Diversidade", "70800006"],
  ["70900000", "Ciência Política", "70000000"],
  ["70901007", "Teoria Política", "70900000"],
  ["70902003", "Estado e Governo", "70900000"],
  ["70903000", "Comportamento Político", "70900000"],
  ["70904006", "Políticas Públicas", "70900000"],
  ["70905002", "Política Internacional", "70900000"],
  ["71000003", "Teologia", "70000000"],
  ["71001000", "História das Teologias e Religiões", "71000003"],
  ["71004009", "Teologia Prática", "71000003"],
  ["71005005", "Teologia Fundamental Sistemática", "71000003"],

  // === 8. LINGUÍSTICA, LETRAS E ARTES ===
  ["80100007", "Linguística", "80000002"],
  ["80101003", "Teoria e Análise Linguística", "80100007"],
  ["80102000", "Filosofia da Linguagem", "80100007"],
  ["80103006", "Linguística Histórica", "80100007"],
  ["80104002", "Sociolinguística e Dialetologia", "80100007"],
  ["80105009", "Psicolinguística", "80100007"],
  ["80106005", "Linguística Aplicada", "80100007"],
  ["80200001", "Letras", "80000002"],
  ["80201008", "Língua Portuguesa", "80200001"],
  ["80202004", "Línguas Estrangeiras Modernas", "80200001"],
  ["80203000", "Línguas Clássicas", "80200001"],
  ["80204007", "Línguas Indígenas", "80200001"],
  ["80205003", "Teoria Literária", "80200001"],
  ["80206000", "Literatura Brasileira", "80200001"],
  ["80207006", "Outras Literaturas Vernáculas", "80200001"],
  ["80208002", "Literaturas Estrangeiras Modernas", "80200001"],
  ["80209009", "Literaturas Clássicas", "80200001"],
  ["80210007", "Literatura Comparada", "80200001"],
  ["80300006", "Artes", "80000002"],
  ["80301002", "Fundamentos e Crítica das Artes", "80300006"],
  ["80302009", "Artes Plásticas", "80300006"],
  ["80303005", "Música", "80300006"],
  ["80304001", "Dança", "80300006"],
  ["80305008", "Teatro", "80300006"],
  ["80306004", "Ópera", "80300006"],
  ["80307000", "Fotografia", "80300006"],
  ["80308007", "Cinema", "80300006"],

  // === 9. MULTIDISCIPLINAR ===
  ["90100000", "Interdisciplinar", "90000005"],
  ["90200004", "Ensino", "90000005"],
  ["90201000", "Ensino de Ciências e Matemática", "90200004"],
  ["90202007", "Ensino de Letras", "90200004"],
  ["90203003", "Ensino de Ciências Humanas", "90200004"],
  ["90204000", "Ensino de Ciências Sociais", "90200004"],
  ["90300009", "Materiais", "90000005"],
  ["90400003", "Biotecnologia", "90000005"],
  ["90500008", "Ciências Ambientais", "90000005"],
];

function determineLevel(code: string, parentCode: string | null): number {
  if (!parentCode) return 1; // Grande Área
  // Find parent's parent to determine depth
  const parent = RAW_DATA.find(d => d[0] === parentCode);
  if (!parent || !parent[2]) return 2; // Area
  const grandparent = RAW_DATA.find(d => d[0] === parent[2]);
  if (!grandparent || !grandparent[2]) return 3; // Subárea
  return 4; // Especialidade
}

function buildFullPath(code: string): string {
  const entry = RAW_DATA.find(d => d[0] === code);
  if (!entry) return "";
  if (!entry[2]) return entry[1]; // Grande Área
  return buildFullPath(entry[2]) + " > " + entry[1];
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const serviceKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, serviceKey);

    // Check if already seeded
    const { count } = await supabase
      .from("cnpq_areas")
      .select("*", { count: "exact", head: true });

    if (count && count > 0) {
      return new Response(
        JSON.stringify({ message: `Already seeded with ${count} entries.` }),
        { headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // Build entries with full paths and levels
    const entries: CnpqEntry[] = RAW_DATA.map(([code, name, parentCode]) => ({
      code,
      name,
      level: determineLevel(code, parentCode),
      parent_code: parentCode,
      full_path: buildFullPath(code),
    }));

    // Insert in batches of 100
    const batchSize = 100;
    let inserted = 0;
    for (let i = 0; i < entries.length; i += batchSize) {
      const batch = entries.slice(i, i + batchSize);
      const { error } = await supabase.from("cnpq_areas").insert(batch);
      if (error) {
        return new Response(
          JSON.stringify({ error: error.message, batch: i }),
          { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
        );
      }
      inserted += batch.length;
    }

    return new Response(
      JSON.stringify({ message: `Successfully seeded ${inserted} CNPq areas.` }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (err) {
    return new Response(
      JSON.stringify({ error: String(err) }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
